package com.CMPUT301F22T25.malwarepolymorphism.features.shoppinglist.data;

import androidx.lifecycle.LiveData;
import androidx.lifecycle.MutableLiveData;

import com.CMPUT301F22T25.malwarepolymorphism.features.recipes.domain.entities.RecipeIngredientMember;
import com.CMPUT301F22T25.malwarepolymorphism.features.shoppinglist.domain.data.ShoppingListRepository;
import com.google.firebase.firestore.CollectionReference;
import com.google.firebase.firestore.DocumentReference;
import com.google.firebase.firestore.FirebaseFirestore;
import com.google.firebase.firestore.QueryDocumentSnapshot;

import java.util.HashMap;
import java.util.List;

import javax.inject.Inject;

public class FirebaseShoppingListRepository implements ShoppingListRepository {
    final FirebaseFirestore database;
    final CollectionReference availableIngredientsCollection;
    private final MutableLiveData<List<RecipeIngredientMember>> shoppingList;

    @Inject
    public FirebaseShoppingListRepository() {
        shoppingList = new MutableLiveData<>();
        database = FirebaseFirestore.getInstance();
        availableIngredientsCollection = database.collection("AvailableIngredients");

        availableIngredientsCollection.whereLessThan("amount",0).addSnapshotListener((queryDocumentSnapshots, error) -> {
            if (queryDocumentSnapshots == null)
                return;

            List<RecipeIngredientMember> requiredIngredients = shoppingList.getValue();
            assert requiredIngredients != null;
            requiredIngredients.clear();
            for (QueryDocumentSnapshot doc : queryDocumentSnapshots) {
                requiredIngredients.add(getIngredientFromDoc(doc));
            }

            shoppingList.postValue(requiredIngredients);
        });
    }


    private RecipeIngredientMember getIngredientFromDoc(QueryDocumentSnapshot doc) {
        return new RecipeIngredientMember(
                doc.getString("description"),
                doc.getLong("amount"),
                doc.getString("unit"),
                doc.getString("category")
        );
    }

    @Override
    public LiveData<List<RecipeIngredientMember>> getShoppingList() {
        return shoppingList;
    }

    @Override
    public void addIngredient(RecipeIngredientMember ingredient) {
        // if doc exists, update it
        // else, create new doc
        DocumentReference docRef = availableIngredientsCollection.document(ingredient.getDescription()+":"+ingredient.getUnit());
        docRef.get().addOnSuccessListener(documentSnapshot -> {
            if (documentSnapshot.exists()) {
                docRef.update("amount", documentSnapshot.getLong("amount") + ingredient.getAmount());
            } else {
                docRef.set(ingredient.toHashMap());
            }
        });
    }

    @Override
    public void addRequiredIngredient(RecipeIngredientMember ingredient) {
        DocumentReference docRef = availableIngredientsCollection.document(ingredient.getDescription()+":"+ingredient.getUnit());
        docRef.get().addOnSuccessListener(documentSnapshot -> {
            if (documentSnapshot.exists()) {
                docRef.update("amount", documentSnapshot.getLong("amount") - ingredient.getAmount());
            } else {
                HashMap<String, Object> data = ingredient.toHashMap();
                data.put("amount", -ingredient.getAmount());
                docRef.set(data);
            }
        });
    }

    @Override
    public void addRequiredIngredients(List<RecipeIngredientMember> ingredients) {
        for (RecipeIngredientMember ingredient : ingredients) {
            addRequiredIngredient(ingredient);
        }
    }

    @Override
    public void removeIngredient(RecipeIngredientMember ingredient) {

    }

    @Override
    public void removeRequiredIngredients(List<RecipeIngredientMember> ingredients) {

    }
}
