package com.CMPUT301F22T25.malwarepolymorphism.features.mealplans.UI;

import android.content.Intent;
import android.os.Bundle;

import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;
import androidx.recyclerview.widget.LinearLayoutManager;

import com.CMPUT301F22T25.malwarepolymorphism.databinding.ActivityViewMealPlanBinding;
import com.CMPUT301F22T25.malwarepolymorphism.features.mealplans.domain.data.MealPlanRepository;
import com.CMPUT301F22T25.malwarepolymorphism.features.mealplans.domain.entities.MealPlan;
import com.CMPUT301F22T25.malwarepolymorphism.features.mealplans.domain.entities.MealPlanRecipeMember;
import com.CMPUT301F22T25.malwarepolymorphism.features.recipes.UI.EditRecipeMemberIngredientAdapter;
import com.CMPUT301F22T25.malwarepolymorphism.features.recipes.UI.ViewRecipeActivity;
import com.CMPUT301F22T25.malwarepolymorphism.features.recipes.domain.data.RecipeRepository;
import com.CMPUT301F22T25.malwarepolymorphism.features.recipes.domain.entities.Recipe;
import com.google.android.material.snackbar.Snackbar;

import javax.inject.Inject;

import dagger.hilt.android.AndroidEntryPoint;

@AndroidEntryPoint
public class ViewMealPlanActivity extends AppCompatActivity {

    @Inject
    MealPlanRepository mealPlanRepository;

    @Inject
    RecipeRepository recipeRepository;

    MealPlan mealPlan;

    ActivityViewMealPlanBinding binding;

    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        mealPlan = mealPlanRepository.getMealPlan(getIntent().getStringExtra("mealPlanId"));

        binding = ActivityViewMealPlanBinding.inflate(getLayoutInflater());

        binding.mealPlanTitle.setText(mealPlan.getTitle());

        String servingsText = mealPlan.getNumberOfServings() + " serving";
        if (mealPlan.getNumberOfServings() > 1)
            servingsText += "s";
        binding.numberOfServings.setText(servingsText);

        // set the recipes in recycler view
        MealPlanRecipeMemberRecyclerViewAdapter recipesAdapter =
                new MealPlanRecipeMemberRecyclerViewAdapter(
                        mealPlan.getRecipes(),
                        position -> {
                            MealPlanRecipeMember selected = mealPlan.getRecipes().get(position);
                            Recipe recipe = recipeRepository.getRecipe(selected.getRecipeId());
                            if (recipe == null) {
                                Snackbar.make(binding.getRoot(),
                                        "That recipe appears to have been deleted!", Snackbar.LENGTH_SHORT)
                                        .show();
                                return;
                            }
                            Intent intent = new Intent(this, ViewRecipeActivity.class);
                            intent.putExtra("recipeId", recipe.getId());
                            startActivity(intent);
                        });

        binding.ingredientsList.setAdapter(
                new EditRecipeMemberIngredientAdapter(mealPlan.getIngredients(), null));

        binding.ingredientsList.setLayoutManager((new LinearLayoutManager(this,
                LinearLayoutManager.VERTICAL, false)));


        binding.deleteIconButton.setOnClickListener(v -> {
            mealPlanRepository.deleteMealPlan(mealPlan.getId());
            finish();
        });

        binding.recipesList.setAdapter(recipesAdapter);
        binding.recipesList.setLayoutManager(new LinearLayoutManager(
                this, LinearLayoutManager.VERTICAL, false));

        setContentView(binding.getRoot());
    }
}
