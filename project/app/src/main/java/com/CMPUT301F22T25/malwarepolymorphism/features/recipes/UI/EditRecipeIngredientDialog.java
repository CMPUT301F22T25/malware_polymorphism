package com.CMPUT301F22T25.malwarepolymorphism.features.recipes.UI;

import android.annotation.SuppressLint;
import android.app.DialogFragment;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;

import androidx.annotation.Nullable;

import com.CMPUT301F22T25.malwarepolymorphism.databinding.FragmentAddIngredientDialogBinding;
import com.CMPUT301F22T25.malwarepolymorphism.features.recipes.domain.entities.RecipeIngredientMember;

import java.util.Objects;

@SuppressLint("ValidFragment")
public class EditRecipeIngredientDialog extends DialogFragment {
    FragmentAddIngredientDialogBinding binding;
    private final EditRecipeViewModel model;



    public EditRecipeIngredientDialog(EditRecipeViewModel model) {
        this.model = model;
    }

    @Nullable
    @Override
    public View onCreateView(LayoutInflater inflater, @Nullable ViewGroup container, Bundle savedInstanceState) {
        super.onCreateView(inflater, container, savedInstanceState);
        binding = FragmentAddIngredientDialogBinding.inflate(inflater, container, false);

        binding.cancelButton.setOnClickListener(view -> dismiss());

        boolean isEditing = getArguments().getBoolean("isEditing", false);
        if (isEditing) {
            prePopulateFields();
        }

        binding.saveButton.setOnClickListener(view -> {
            RecipeIngredientMember newMember = getIngredientFromFields();
            if (newMember == null) { return; }
            else if (isEditing) {
                model.getSelectedMember()
                        .setDescription(newMember.getDescription());
                model.getSelectedMember()
                        .setAmount(newMember.getAmount());
                model.getSelectedMember()
                        .setUnit(newMember.getUnit());
                model.getSelectedMember()
                        .setCategory(newMember.getCategory());
                model.forceReload();
            } else {
                model.addIngredientToSelected(newMember);
            }
            dismiss();
        });
        return binding.getRoot();
    }

    void prePopulateFields() {
        binding.titleTextField.setText("Edit Ingredient");
        binding.saveButton.setText("Save");
        binding.deleteIconButton.setVisibility(View.VISIBLE);
        RecipeIngredientMember selected = model.getSelectedMember();
        binding.deleteIconButton.setOnClickListener(view -> {
            model.removeIngredientFromSelected(selected);
            dismiss();
        });
        Objects.requireNonNull(binding.descriptionTextField.getEditText())
                .setText(selected.getDescription());
        Objects.requireNonNull(binding.amountTextField.getEditText())
                .setText(String.valueOf(selected.getAmount()));
        Objects.requireNonNull(binding.unitTextField.getEditText())
                .setText(selected.getUnit());
        Objects.requireNonNull(binding.categoryTextField.getEditText())
                .setText(selected.getCategory());
    }

    RecipeIngredientMember getIngredientFromFields() {
        String descriptionInput = Objects.requireNonNull(binding.descriptionTextField.getEditText())
                .getText().toString();
        String amountTextField  = Objects.requireNonNull(binding.amountTextField.getEditText())
                .getText().toString();
        String categoryInput = Objects.requireNonNull(binding.categoryTextField.getEditText())
                .getText().toString();
        String unitInput = Objects.requireNonNull(binding.unitTextField.getEditText())
                .getText().toString();

        // validate input
        boolean isValid = true;
        if (descriptionInput.isEmpty()) {
            binding.descriptionTextField.setError("Description cannot be empty");
            isValid = false;
        }
        if (amountTextField.isEmpty()) {
            binding.amountTextField.setError("Amount cannot be empty");
            isValid = false;
        }
        if (categoryInput.isEmpty()) {
            binding.categoryTextField.setError("Category cannot be empty");
            isValid = false;
        }
        if (unitInput.isEmpty()) {
            binding.unitTextField.setError("Unit cannot be empty");
            isValid = false;
        }
        if (!isValid) {
            return null;
        }

        return new RecipeIngredientMember(
                descriptionInput,
                Long.parseLong(amountTextField),
                unitInput,
                categoryInput);
    }
}
