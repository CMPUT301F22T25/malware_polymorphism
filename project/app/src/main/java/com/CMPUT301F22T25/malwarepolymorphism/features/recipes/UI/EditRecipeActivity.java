package com.CMPUT301F22T25.malwarepolymorphism.features.recipes.UI;

import android.annotation.SuppressLint;
import android.net.Uri;
import android.os.Bundle;
import android.util.Log;
import android.view.View;

import androidx.activity.result.ActivityResultLauncher;
import androidx.activity.result.contract.ActivityResultContract;
import androidx.activity.result.contract.ActivityResultContracts;
import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.content.FileProvider;
import androidx.lifecycle.ViewModelProvider;
import androidx.recyclerview.widget.LinearLayoutManager;

import com.CMPUT301F22T25.malwarepolymorphism.databinding.ActivityRecipeEditBinding;
import com.CMPUT301F22T25.malwarepolymorphism.features.common.RecyclerViewOnItemClickHandler;
import com.CMPUT301F22T25.malwarepolymorphism.features.recipes.domain.data.RecipeAttributeBundle;
import com.CMPUT301F22T25.malwarepolymorphism.features.recipes.domain.data.RecipeRepository;
import com.CMPUT301F22T25.malwarepolymorphism.features.recipes.domain.entities.Recipe;
import com.CMPUT301F22T25.malwarepolymorphism.features.recipes.domain.entities.RecipeIngredientMember;
import com.bumptech.glide.Glide;

import java.io.File;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;

import javax.inject.Inject;

import dagger.hilt.android.AndroidEntryPoint;

@AndroidEntryPoint
public class EditRecipeActivity extends AppCompatActivity implements RecyclerViewOnItemClickHandler {
    @Inject
    RecipeRepository recipeRepository;

    private ActivityRecipeEditBinding binding;

    EditRecipeMemberIngredientAdapter adapter;

    List<RecipeIngredientMember> recipeIngredients;

    EditRecipeViewModel model;

    @SuppressLint("NotifyDataSetChanged")
    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        binding = ActivityRecipeEditBinding.inflate(getLayoutInflater());
        setContentView(binding.getRoot());

        ActivityResultContract<Integer, RecipeIngredientMember> contract = new
                AddIngredientToRecipeActivity.AddIngredientContract();

        ActivityResultLauncher<Uri> getImageActivity = registerForActivityResult(
                new ActivityResultContracts.TakePicture(), data -> {
                    // TODO: Upload image here and disable saving and going back.
                });

        ActivityResultLauncher<Integer> selectIngredient =
                registerForActivityResult(contract, data -> {
                    if (data == null)
                        return;
                    model.addIngredientToSelected(data);
            });


        model = new ViewModelProvider(this).get(EditRecipeViewModel.class);
        recipeIngredients = new ArrayList<>();

        adapter = new EditRecipeMemberIngredientAdapter(recipeIngredients, this);
        binding.ingredientsRecyclerView.setAdapter(adapter);
        binding.ingredientsRecyclerView.setLayoutManager(new LinearLayoutManager(this,
                LinearLayoutManager.VERTICAL, false));

        binding.imageView.setOnClickListener(view -> {
            File tempDir = this.getCacheDir();
            try {

                File imgDirPath = new File(getFilesDir(), "imgs");
                imgDirPath.mkdirs();
                File file = new File(imgDirPath, "img.png");
                Uri imgURI = FileProvider.getUriForFile(this, getApplicationContext().getPackageName() + ".fileprovider", file);
                getImageActivity.launch(imgURI);
            } catch (Exception e) {
                e.printStackTrace();
            }
        });

        model.getCurrentlySelectedIngredients().observe(this, recipeIngredientMembers -> {
            adapter.setIngredients(recipeIngredientMembers);
            adapter.notifyDataSetChanged();
            recipeIngredients = recipeIngredientMembers;
        });

        boolean isEditing = getIntent().getBooleanExtra("isEditing", false);

        if (isEditing)
            prePopulateFields();

        binding.cancelButton.setOnClickListener(view -> finish());

        binding.addIngredientsButton.setOnClickListener(view -> {
            EditRecipeIngredientDialog dialog = new EditRecipeIngredientDialog(model);
            Bundle args = new Bundle();
            dialog.setArguments(args);
            dialog.show(getFragmentManager(), "ADD");
        });

        binding.selectIngredientsButton.setOnClickListener(view -> {
            selectIngredient.launch(1);
        });

        // TODO: Add validation here.
        binding.saveButton.setOnClickListener(view -> {
            String title = Objects.requireNonNull(binding.titleTextField.getEditText())
                    .getText().toString();
            String preparationTimeInput = Objects.requireNonNull(
                    binding.preparationTimeTextField.getEditText()).getText().toString();

            String numberOfServingsInput = Objects.requireNonNull(binding.numberOfServingsTextField
                    .getEditText()).getText().toString();

            String categoryInput = Objects.requireNonNull(
                    binding.categoryTextField.getEditText()).getText().toString();

            String commentInput = Objects.requireNonNull(
                    binding.commentsTextField.getEditText()).getText().toString();

            // validate input
            boolean validInput = true;
            if (title.isEmpty()) {
                binding.titleTextField.setError("Title cannot be empty");
                validInput = false;
            }
            if (preparationTimeInput.isEmpty()) {
                binding.preparationTimeTextField.setError("Preparation time cannot be empty");
                validInput = false;
            }
            if (numberOfServingsInput.isEmpty()) {
                binding.numberOfServingsTextField.setError("Number of servings cannot be empty");
                validInput = false;
            }
            if (categoryInput.isEmpty()) {
                binding.categoryTextField.setError("Category cannot be empty");
                validInput = false;
            }
            if (commentInput.isEmpty()) {
                binding.commentsTextField.setError("Comment cannot be empty");
                validInput = false;
            }

            if (!validInput) {
                return;
            }

            RecipeAttributeBundle bundle = new RecipeAttributeBundle(
                title,
                    Long.parseLong(preparationTimeInput),
                    Long.parseLong(numberOfServingsInput),
                    categoryInput,
                    commentInput,
                    "https://www.acouplecooks.com/wp-content/uploads/2019/05/Chopped-Salad-001_1.jpg",
                    recipeIngredients
            );
            if (isEditing)
                recipeRepository.modifyRecipe(getIntent().getStringExtra("recipeId"), bundle);
            else
                recipeRepository.addRecipe(bundle);
            finish();
        });

    }

    @SuppressLint({"SetTextI18n", "NotifyDataSetChanged"})
    void prePopulateFields() {
        String recipeId = getIntent().getStringExtra("recipeId");

        Recipe recipe = recipeRepository.getRecipe(recipeId);

        Glide.with(binding.getRoot())
                .load(recipe.getImageUrl())
                .fitCenter()
                .into(binding.imageView);

        // Set the title to reflect that we are editing a recipe.
        binding.deleteRecipeIconButton.setVisibility(View.VISIBLE);

        binding.deleteRecipeIconButton.setOnClickListener(view -> {
            recipeRepository.deleteRecipe(recipeId);
            finish();
        });

        Objects.requireNonNull(binding.titleTextField.getEditText())
                .setText(recipe.getTitle());

        Objects.requireNonNull(binding.preparationTimeTextField.getEditText())
                .setText(String.valueOf(recipe.getPreparationTimeInMinutes()));

        Objects.requireNonNull(binding.numberOfServingsTextField.getEditText())
                .setText(String.valueOf(recipe.getNumberOfServings()));

        Objects.requireNonNull(binding.categoryTextField.getEditText())
                .setText(recipe.getCategory());

        Objects.requireNonNull(binding.commentsTextField.getEditText())
                .setText(recipe.getComments());

        model.setCurrentlySelectedIngredients(recipe.getIngredients());
    }

    @Override
    public void onRecyclerViewItemClicked(int position) {
        model.setSelectedMember(recipeIngredients.get(position));
        EditRecipeIngredientDialog dialog = new EditRecipeIngredientDialog(model);
        Bundle args = new Bundle();
        args.putBoolean("isEditing", true);
        dialog.setArguments(args);
        dialog.show(getFragmentManager(), "TAG");
        Log.w("EditRecipeActivity", "Clicked on the ingredient " + recipeIngredients.get(position).getDescription());
    }
}
